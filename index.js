// index.js

let argv = require('yargs')
	.usage('Usage: $0 [cve list]')
	.example('$0 CVE-2020-24589', 'extracts the CVE and WSO2 Security Advisory information')
	.alias('s', 'save')
	.nargs('s', 0)
	.describe('s', 'Save the results')
	.help('h')
	.alias('h', 'help').argv;

const path = require('path');
const fs = require('fs');
const ora = require('ora');
const { scrapeData } = require('./scrape/index.nvd');

let args = {};
args.cves = argv._;
args.save = argv['save'];

(async () => {
	let security = [];
	for (let vulnerableID of args.cves) {
		const spinner = ora(`scraping ${vulnerableID}`).start();
		try {
			security.push({ cve: vulnerableID, info: await scrapeData(vulnerableID) });
			spinner.succeed();
		} catch (err) {
			if (spinner.isSpinning) spinner.fail();
			console.error(err.message);
		}
	}
	if (args.save) {
		let name = Date.now();
		const spinner = ora(`saving output to ${name}.json`).start();
		fs.writeFileSync(path.join(process.cwd(), `${name}.json`), JSON.stringify(security), {
			encoding: 'utf-8',
		});
		spinner.succeed();
	} else {
		console.dir(security, { depth: 5 });
	}
})();
